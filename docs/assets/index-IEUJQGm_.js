(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();let y=class{constructor(t={}){this.type="none",this.x=0,this.y=0,this.w=0,this.h=0;const e=document.createElement("canvas"),i=e.getContext("2d");this._capture={cav:e,ctx:i},this.InitChildren()}InitChildren(){this.children={none:[],point:[],square:[],line:[],button:[]}}SetData(t={}){Object.entries(t).forEach(([e,i])=>{this[e]=i})}FindByID(t){for(const e in this.children??{})for(const i of this.children[e]??[])if(i.id===t)return i;return null}AddChild(t){this.FindByID(t.id)||this.children[t.type].push(t)}MoveChildLast(t){const e=this.children[t.type];if(e){for(let i=0;i<e.length;i++)if(e[i].id===t.id){const[s]=e.splice(i,1);e.push(s);return}}}DeleteChild(t){const e=this.children[t.type];if(e){for(let i=0;i<e.length;i++)if(e[i].id===t.id)return e.splice(i,1),!0}}},x=class extends y{constructor(t={}){super(t),this.type="point",this.x=t.x??0,this.y=t.y??0,this.w=301,this.h=301,this.cx=151,this.cy=151,this.color=t.color??"white";const e=this._capture.cav,i=this._capture.ctx;w.SetCanvasDPR(e,i,this.w,this.h),i.font=`${l.fontWeight} ${l.fontSize}px ${l.fontFamily}`,i.fillStyle=this.color,i.textAlign="center",i.textBaseline="middle"}get ui(){return{type:"point",x:this.x,y:this.y,color:this.color}}set ui(t){const e=["type","x","y","color"];for(const i of e)t[i]!==void 0&&(this[i]=t[i])}async Save(t){this.SetData(t),this.id=await g.Call("saveDiagram",{id:this.id,ui:this.ui,parentID:this.parentID,tabID:this.tabID,timestamp:Date.now()}),this.Render()}Render(){const t=this._capture.cav,e=this._capture.ctx,i=4;e.clearRect(0,0,t.width,t.height),e.fillText(`( ${this.x}, ${this.y} )`,this.w/2,this.h/2+l.textHeight),e.beginPath(),e.arc(this.w/2,this.h/2,i,Math.PI*2,!1),e.fill()}Draw(t,e){if(e==null)return;const i=t.PixelX(this.x)-this.cx,s=t.PixelY(this.y)-this.cy,n=this.w,o=this.h;e.drawImage(this._capture.cav,0,0,this._capture.cav.width,this._capture.cav.height,i,s,n,o)}},v=class{constructor(t){if(!t||!t.type)return;const e=document.createElement(t.type);return t.class&&e.classList.add(...t.class.split(" ")),t.id&&(e.id=t.id),t.parentNode&&t.parentNode.appendChild(e),e}};const p=Math.round(window.devicePixelRatio)||1,D={SetCanvasDPR:M};function M(r,t,e,i){r.width=e*p,r.height=i*p,t.setTransform(1,0,0,1,0,0),t.scale(p,p)}const f={axis:y,point:x},I={element:v},w=D,l=(function(){const r=getComputedStyle(document.documentElement),t={};return t.fontFamily=r.getPropertyValue("font-family"),t.fontSize=parseFloat(r.getPropertyValue("font-size")),t.fontWeight=parseFloat(r.getPropertyValue("font-weight")),t.textHeight=Math.round(t.fontSize*1.3),t})();let L=class{constructor(t={}){}},_=class{constructor(t={}){}},P=class{constructor(t={}){}},S=class extends f.axis{constructor(t={}){super(t),this.scope={dpr:1,min:1,max:6,zoom:1,width:0,height:0},this.layers={},this.InitLayers(t.parentNode),window.addEventListener("resize",e=>{this.Resize()}),this.Resize(),this.diagrams=[],this.Loop()}Loop=()=>{this.isDataUpdate&&(this.DataUpdate(),this.isDataUpdate=!1),this.isLogUpdate&&(this.LogUpdate(),this.isLogUpdate=!1),(this.isDragging||this.isResizing||this.isLoading)&&(this.Draw(),this.isDragging=!1,this.isResizing=!1,this.isLoading=!1),requestAnimationFrame(this.Loop)};get zoom(){return this.scope.zoom}set zoom(t){t>=this.scope.min&&t<=this.scope.max&&(this.scope.zoom=t)}async LoadDiagrams(t){this.tabID=t,this.InitChildren();const e=await g.Call("loadTab",{tabID:t});if(!e)return;const i=e.diagrams;if(i){this.id=e.tab.openDiagramID;for(const s of i){if(!s.ui||!f[s.ui.type])continue;const n=new f[s.ui.type]({});n.SetData(s),n.Render(),this.AddChild(n)}this.isLoading=!0}}InitLayers(t){this.layers={},["background","board","effect"].forEach(e=>{this.layers[e]={},this.layers[e].cav=new I.element({type:"canvas",parentNode:t,class:`window ${e}`}),this.layers[e].cav.style.position="absolute",this.layers[e].cav.style.width="100%",this.layers[e].cav.style.height="100%",this.layers[e].ctx=this.layers[e].cav.getContext("2d")})}Resize(){this.scope.width=window.innerWidth,this.scope.height=window.innerHeight,Object.values(this.layers).forEach(t=>{w.SetCanvasDPR(t.cav,t.ctx,window.innerWidth,window.innerHeight),t.ctx.translate(window.innerWidth/2,window.innerHeight/2)}),this.isResizing=!0}SpaceX(t){return this.x+Math.round((t-this.scope.width/2)*this.zoom)}SpaceY(t){return this.y+Math.round((t-this.scope.height/2)*this.zoom)}SpaceLine(t){return Math.round(t*this.zoom)}PixelX(t){return Math.round((t-this.x)/this.zoom)}PixelY(t){return Math.round((t-this.y)/this.zoom)}PixelLine(t){return Math.round(t/this.zoom)}Draw(){Object.values(this.layers).forEach(t=>{const e=t.cav.width,i=t.cav.height;t.ctx.clearRect(-e/2,-i/2,e,i)}),this.DrawBackground(),this.DrawLine(100,200,200,100,"orange"),this.DrawLine(0,0,200,100,"orange"),this.DrawLine(0,0,100,200,"orange"),["none","point"].forEach(t=>{const e=this.children[t];for(const i of e)i.Draw(this,this.layers.board.ctx)})}DrawRuler(){if(!this.layers.background)return;const t=this.layers.background.ctx,e=-this.scope.width/2+10,i=-this.scope.height/2+10,s=100,n=this.scope.height-20;t.fillStyle="rgba(44, 44, 54, 1)",t.fillRect(e,i,s,n)}DrawBackground(){if(!this.layers.background)return;const t=this.layers.background.ctx;this.layers.background.cav;const e=100,i=-this.x%e,n=-this.y%200;t.save(),t.strokeStyle="rgba(64, 64, 64, 1)",t.beginPath();const o=this.scope.height;for(let h=i-this.scope.width;h<=this.scope.width;h+=e){const a=this.PixelLine(h);t.moveTo(a-o,n-o),t.lineTo(a+o,n+o),t.moveTo(a-o,n+o),t.lineTo(a+o,n-o)}t.stroke(),t.restore()}DrawPoint(t,e,i){if(!this.layers.background)return;const s=this.layers.background.ctx,n=this.PixelX(t),o=this.PixelY(e);s.save(),s.font=`${l.fontWeight} ${l.fontSize}px ${l.fontFamily}`,s.fillStyle=i,s.textAlign="center",s.textBaseline="middle",s.fillText(`( ${t}, ${e} )`,n,o+l.textHeight),s.beginPath(),s.arc(n,o,4,Math.PI*2,!1),s.fill(),s.restore()}DrawLine(t,e,i,s,n){if(!this.layers.background)return;const o=this.layers.background.ctx,h=this.PixelX(t),a=this.PixelY(e),d=this.PixelX(i),m=this.PixelY(s);o.save(),o.strokeStyle=n,o.beginPath(),o.moveTo(h,a),o.lineTo(d,m),o.stroke(),o.restore()}};const b=.001,A=.002;let N=class{constructor(t={}){const e=t.parentNode;e.addEventListener("contextmenu",async i=>{i.preventDefault()}),e.addEventListener("wheel",i=>{c.zoom-=i.deltaY*b,c.isDragging=!0},{passive:!0}),e.addEventListener("mousedown",i=>{this.PanStart(i.offsetX,i.offsetY)}),e.addEventListener("mousemove",i=>{this.PanMove(i.offsetX,i.offsetY)}),e.addEventListener("mouseup",i=>{this.PanEnd(i.offsetX,i.offsetY)}),e.addEventListener("mouseleave",()=>{this.down=null}),e.addEventListener("touchstart",i=>{if(i.touches.length===1&&this.touchMode!=="pinch"){const s=i.touches[0];this.touchMode="pan",this.PanStart(s.clientX,s.clientY)}if(i.touches.length===2){const s=i.touches[0],n=i.touches[1],o=s.clientX-n.clientX,h=s.clientY-n.clientY;this.touchMode="pinch",this.pinch={dist:Math.hypot(o,h)}}},{passive:!1}),e.addEventListener("touchmove",i=>{if(this.touchMode==="pan"&&i.touches.length===1){const s=i.touches[0];this.PanMove(s.clientX,s.clientY),i.preventDefault()}if(this.touchMode==="pinch"&&i.touches.length===2&&this.pinch){const s=i.touches[0],n=i.touches[1],o=s.clientX-n.clientX,h=s.clientY-n.clientY,a=Math.hypot(o,h),d=this.pinch.dist-a;this.pinch.dist=a,c.zoom+=d*A,c.isDragging=!0,i.preventDefault()}},{passive:!1}),e.addEventListener("touchend",i=>{if(this.touchMode==="pinch"&&i.touches.length<2){this.touchMode=null,this.pinch=null;return}if(this.touchMode==="pan"&&i.touches.length===0){const s=i.changedTouches[0],n=e.getBoundingClientRect(),o=s.clientX-n.left,h=s.clientY-n.top;this.touchMode=null,this.panEnd(o,h)}})}PanStart(t,e){this.down={offsetX:t,offsetY:e,xView:c.x,yView:c.y},c.isDragging=!0}PanMove(t,e){if(!this.down)return;const i=c.SpaceLine(t-this.down.offsetX),s=c.SpaceLine(e-this.down.offsetY);c.x=this.down.xView-i,c.y=this.down.yView-s,c.isDragging=!0}async PanEnd(t,e){this.down=null;const i=new f.point({x:c.SpaceX(t),y:c.SpaceY(e),color:"red"});await i.Save({parentID:c.id,tabID:c.tabID}),c.AddChild(i),c.Draw()}};const C={};class E{constructor(t={}){this.worker=null,this.seq=0,this.pending=new Map;const i=!(typeof import.meta<"u"&&C);this.worker=i?new Worker("./src/storage/db.worker.js",{type:"module"}):new Worker(new URL(""+new URL("db.worker-BnZWucuG.js",import.meta.url).href,import.meta.url),{type:"module"}),this.worker.onmessage=s=>{const{id:n,ok:o,result:h,error:a}=s.data,d=this.pending.get(n);d&&(this.pending.delete(n),o?d.resolve(h):(d.reject(a),console.warn(s.data)))},this.worker.onerror=s=>{console.error("worker error:",s.message)}}Call(t,e){return new Promise((i,s)=>{const n=++this.seq;this.pending.set(n,{resolve:i,reject:s}),this.worker.postMessage({id:n,type:t,payload:e})})}}const R=document.querySelector("#app"),g=new E;u(P,"menu");u(_,"favorite");u(L,"directory");const c=u(S,"view");u(N,"controller");const k=async()=>{await g.Call("init");const r=await g.Call("loadSetting",{});await c.LoadDiagrams(r.openTabID)};k();function u(r,t){const e=document.createElement("div");return e.id=t,R.appendChild(e),new r({parentNode:e})}
