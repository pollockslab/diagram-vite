(function(){"use strict";const u={version:1,work_date:"2026-01-03 07:35",tables:[{name:"version_history",desc:"업로드한 버전정보 기록",column:["id","version","versionPrev","workDate","timestamp"],options:{keyPath:"id",autoIncrement:!0},index:[]},{name:"log",desc:"오류정보, 탭 불러오기, 가져오기 기록",column:["id","code","ext","timestamp"],options:{keyPath:"id",autoIncrement:!0},index:[{key:"byCode",column:"code",options:{unique:!1}}]},{name:"setting",desc:"설정",column:["id","openTabID"],options:{keyPath:"id",autoIncrement:!0},index:[]},{name:"tab",desc:"새 창 열기. json 내보내기 단위",column:["id","openDiagramID","favorites","timestamp"],options:{keyPath:"id",autoIncrement:!1},index:[]},{name:"diagram",desc:"도형(클래스, 함수, 메모), 라인(기본선, 점선등)",desc2:"ui내용: 기본 x,y,w,h 그리고 각자 텍스트등, 라인은 연결 다이어그램등",column:["id","ui","children","parent","timestamp"],options:{keyPath:"id",autoIncrement:!1},index:[]}]};async function l(t,{spaceId:e,info:n}){const o=await t.get("space",e);if(!o)throw new Error("space not found");const r=await t.get("diagram",o.diagramID);if(!r)throw new Error("diagram not found");return r.info=n,await t.put("diagram",r),!0}async function p(t,{nodes:e}){return await t.delAll("nodes",e.map(n=>n.id)),await t.putAll("nodes",e),!0}async function g(t,{}){let e=await t.get("setting",1);if(!e){await t.put("log",{code:"tx",ext:"loadSetting. first enter",timestamp:Date.now()});const n=t.generateUUID();await t.put("diagram",{id:n,ui:null,children:null,parent:null,timestamp:Date.now()});const o=t.generateUUID();await t.put("tab",{id:o,openDiagramID:n,favorites:null,timestamp:Date.now()}),await t.put("setting",{openTabID:o}),e=await t.get("setting",1)}if(await t.get("tab",e.openTabID)===null){await t.put("log",{code:"tx",ext:"loadSetting. new tab",timestamp:Date.now()});const n=t.generateUUID();await t.put("diagram",{id:n,ui:null,children:null,parent:null,timestamp:Date.now()});const o=t.generateUUID();await t.put("tab",{id:o,openDiagramID:n,favorites:null,timestamp:Date.now()}),await t.put("setting",{openTabID:o}),e=await t.get("setting",1)}return e}var f=Object.freeze({__proto__:null,loadSetting:g,saveDiagram:p,updateDiagram:l});let d=null;self.onmessage=async t=>{const{id:e,type:n,payload:o}=t.data;try{if(n==="init"){d||(d=await h()),self.postMessage({id:e,ok:!0});return}if(!d)throw new Error("DB not initialized");const r=f[n];if(!r)throw new Error(`Unknown transaction: ${n}`);const i=w(d),a=await r(i,o);self.postMessage({id:e,ok:!0,result:a})}catch(r){self.postMessage({id:e,ok:!1,error:r?.message??String(r)})}};function w(t){return{get(e,n){const o=y(t,e);return I(o.get(n))},put(e,n){const o=t.transaction(e,"readwrite");return o.objectStore(e).put(n),s(o)},putAll(e,n){const o=t.transaction(e,"readwrite"),r=o.objectStore(e);for(const i of n)r.put(i);return s(o)},del(e,n){const o=t.transaction(e,"readwrite");return o.objectStore(e).delete(n),s(o)},delAll(e,n){const o=t.transaction(e,"readwrite"),r=o.objectStore(e);for(const i of n)r.delete(i);return s(o)},clear(e){const n=t.transaction(e,"readwrite");return n.objectStore(e).clear(),s(n)},generateUUID:S}}const D=new Set(u.tables.map(t=>t.name));function x(t){if(!D.has(t))throw new Error(`Invalid table: ${t}`)}function y(t,e,n="readonly"){return x(e),t.transaction(e,n).objectStore(e)}function I(t){return new Promise((e,n)=>{t.onsuccess=()=>e(t.result),t.onerror=()=>n(t.error)})}function s(t){return new Promise((e,n)=>{t.oncomplete=()=>e(!0),t.onerror=()=>n(t.error),t.onabort=()=>n(t.error)})}function h(){return new Promise((t,e)=>{const n=indexedDB.open("diagramDB",u.version);n.onupgradeneeded=o=>{const r=o.target.result,i=o.target.transaction;u.tables.forEach(a=>{let c;r.objectStoreNames.contains(a.name)?c=i.objectStore(a.name):c=r.createObjectStore(a.name,a.options),a.index?.forEach(m=>{c.indexNames.contains(m.key)||c.createIndex(m.key,m.column,m.options)}),a.name==="version_history"&&c.put({version:o.newVersion,versionPrev:o.oldVersion||null,workDate:u.work_date,timestamp:Date.now()})})},n.onsuccess=()=>t(n.result),n.onerror=()=>e(n.error)})}function S(){if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID();if(typeof crypto<"u"&&crypto.getRandomValues){const t=new Uint8Array(16);crypto.getRandomValues(t),t[6]=t[6]&15|64,t[8]=t[8]&63|128;let e=0;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const o=t[e++]&15;return(n==="x"?o:o&3|8).toString(16)})}return Date.now().toString(36)+"-"+Math.random().toString(36).slice(2,10)}})();
