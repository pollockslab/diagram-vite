(function(){"use strict";const d={version:2,work_date:"2025-12-31 00:33",tables:[{name:"version_history",desc:"업로드한 버전정보 기록",column:["id","version","versionPrev","workDate","timestamp"],options:{keyPath:"id",autoIncrement:!0},index:[{key:"byVersion",column:"version",options:{unique:!1}}]},{name:"log",desc:"오류정보, 탭 불러오기, 가져오기 기록",column:["id","code","ext","timestamp"],options:{keyPath:"id",autoIncrement:!0},index:[{key:"byCode",column:"code",options:{unique:!1}}]},{name:"setting",desc:"설정",column:["id","tab"],options:{keyPath:"id",autoIncrement:!0},index:[]},{name:"tab",desc:"새 창 열기. json 내보내기 단위",column:["id","space","favorites","timestamp"],options:{keyPath:"id",autoIncrement:!1},index:[]},{name:"space",desc:"도형, 라인들을 품은 공간. 상자 하나당 가지고 있는 공간",column:["id","info","directory","timestamp"],options:{keyPath:"id",autoIncrement:!1},index:[]},{name:"diagram",desc:"도형(클래스, 함수, 메모), 라인(기본선, 점선등)",column:["id","info","parent","timestamp"],options:{keyPath:"id",autoIncrement:!1},index:[]}]};let m=null;const l={async init(){return m||(m=await y()),!0},async get({table:e,key:n}){s(e);const t=i(e);return await w(t,n)},async put({table:e,data:n}){s(e);const t=i(e,"readwrite");return await f(t,n),!0},async putList({table:e,list:n}){s(e);const t=i(e,"readwrite");for(const o of n)await f(t,o);return!0},async del({table:e,key:n}){s(e);const t=i(e,"readwrite");return await p(t,n),!0},async delList({table:e,list:n}){s(e);const t=i(e,"readwrite");for(const o of n)await p(t,o);return!0},async clear({table:e}){return s(e),i(e,"readwrite").clear(),!0}};self.onmessage=async e=>{const{id:n,type:t,payload:o}=e.data;try{if(!l[t])throw new Error(`Unknown command: ${t}`);const r=await l[t](o);self.postMessage({id:n,ok:!0,result:r})}catch(r){self.postMessage({id:n,ok:!1,error:r?.message??String(r)})}};function s(e){if(!TABLES.has(e))throw new Error(`Invalid table: ${e}`)}function i(e,n="readonly"){return m.transaction(e,n).objectStore(e)}function y(){return new Promise((e,n)=>{const t=indexedDB.open("diagramDB",d.version);t.onupgradeneeded=o=>{const r=o.target.result,k=o.target.transaction;d.tables.forEach(a=>{let c;r.objectStoreNames.contains(a.name)?c=k.objectStore(a.name):c=r.createObjectStore(a.name,a.options),a.index?.forEach(u=>{c.indexNames.contains(u.key)||c.createIndex(u.key,u.column,u.options)}),a.name==="version_history"&&c.put({version:o.newVersion,versionPrev:o.oldVersion||null,workDate:d.work_date,timestamp:Date.now()})})},t.onsuccess=()=>e(t.result),t.onerror=()=>n(t.error)})}function w(e,n){return new Promise((t,o)=>{const r=e.get(n);r.onsuccess=()=>t(r.result),r.onerror=()=>o(r.error)})}function f(e,n){return new Promise((t,o)=>{const r=e.put(n);r.onsuccess=()=>t(),r.onerror=()=>o(r.error)})}function p(e,n){return new Promise((t,o)=>{const r=e.delete(n);r.onsuccess=()=>t(),r.onerror=()=>o(r.error)})}})();
